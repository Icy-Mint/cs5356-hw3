<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IESVE Energy Comparison</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
    }
    #chart {
      margin-top: 2rem;
    }
    .legend rect {
      stroke: #fff;
      stroke-width: 1px;
    }
  </style>
</head>
<body>
  <a href="import.html" style="display: inline-block; margin: 1rem 2rem; color: #333; text-decoration: none;"
     onmouseover="this.style.textDecoration='underline'"
     onmouseout="this.style.textDecoration='none'">‚Üê Back to Previous Page</a>

  <h2>Annual Energy Breakdown: Current vs Future</h2>
  <div id="chart"></div>

  <script>
    const rawCsvCurrent = localStorage.getItem("iesveCsvData");
    const rawCsvFuture = localStorage.getItem("iesveFutureCsvData");

    if (!rawCsvCurrent || !rawCsvFuture) {
      document.body.innerHTML = "<p>Missing CSV data. Please upload both current and future files first.</p>";
      throw new Error("Missing CSV data");
    }

    const keys = [
      "Interior Lighting (MBtu)",
      "Receptacle Equipment (MBtu)",
      "Space Heating (MBtu)",
      "Service Water Heating (MBtu)",
      "Space Cooling (MBtu)",
      "Heat Rejection (MBtu)",
      "Interior Central Fans (MBtu)",
      "Interior Local Fans (MBtu)",
      "Exhaust Fans (MBtu)",
      "Pumps (MBtu)"
    ];

    function parseCsvTotals(csvText) {
      const lines = csvText.split("\n").map(l => l.split(","));
      const headers = lines[4].map(h => h.trim());
      const totalRow = lines[19];
      const totals = {};
      headers.forEach((h, i) => {
        if (keys.includes(h)) {
          totals[h] = parseFloat(totalRow[i]) || 0;
        }
      });
      return totals;
    }

    const currentTotals = parseCsvTotals(rawCsvCurrent);
    const futureTotals = parseCsvTotals(rawCsvFuture);

    const chartData = [
      { label: "Current", ...currentTotals },
      { label: "Future", ...futureTotals }
    ];

    drawChart(chartData, keys);

    function drawChart(data, keys) {
      const margin = { top: 40, right: 160, bottom: 60, left: 60 },
            width = 700 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

      const svg = d3.select("#chart")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      const stack = d3.stack().keys(keys);
      const stackedData = stack(data);

      const maxTotal = d3.max(data, d => keys.reduce((sum, k) => sum + d[k], 0));

      const x = d3.scaleBand()
        .domain(data.map(d => d.label))
        .range([0, width])
        .padding(0.4);

      const y = d3.scaleLinear()
        .domain([0, maxTotal])
        .range([height, 0]);

      const color = d3.scaleOrdinal()
        .domain(keys)
        .range(d3.schemeCategory10);

      svg.selectAll("g.layer")
        .data(stackedData)
        .join("g")
        .attr("class", "layer")
        .attr("fill", d => color(d.key))
        .selectAll("rect")
        .data(d => d)
        .join("rect")
        .attr("x", d => x(d.data.label))
        .attr("y", d => y(d[1]))
        .attr("height", d => y(d[0]) - y(d[1]))
        .attr("width", x.bandwidth());

      // X-axis
      svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x));

      // Y-axis
      svg.append("g")
        .call(d3.axisLeft(y));

      // X-label
      svg.append("text")
        .attr("x", width / 2)
        .attr("y", height + 40)
        .attr("text-anchor", "middle")
        .style("font-size", "14px")
        .text("Energy Scenario");

      // Y-label
      svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("x", -height / 2)
        .attr("y", -40)
        .attr("text-anchor", "middle")
        .style("font-size", "14px")
        .text("Annual Energy Consumption (Million BTU)");

      // Legend
      const legend = svg.append("g")
        .attr("transform", `translate(${width + 10}, 0)`);

      keys.forEach((key, i) => {
        legend.append("rect")
          .attr("x", 0)
          .attr("y", i * 20)
          .attr("width", 12)
          .attr("height", 12)
          .attr("fill", color(key));

        legend.append("text")
          .attr("x", 18)
          .attr("y", i * 20 + 10)
          .attr("font-size", "12px")
          .text(key);
      });
    }
  </script>
</body>
</html>
