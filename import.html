<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import CSV - SmartWatts</title>
    <link rel="stylesheet" href="style.css">

    <style>
        .import-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .import-form {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .upload-section {
            border: 1px solid #eee;
            padding: 1.5rem;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .upload-section h3 {
            margin-top: 0;
            color: #333;
        }
        .file-input {
            padding: 1rem;
            border: 2px dashed #ccc;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            background: #fff;
            margin: 1rem 0;
        }
        .file-input:hover {
            border-color: #666;
        }
        .submit-btn {
            background: #333;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            margin-top: 1rem;
        }
        .submit-btn:hover {
            background: #444;
        }
        .back-btn {
            display: inline-block;
            margin-bottom: 1rem;
            color: #333;
            text-decoration: none;
        }
        .back-btn:hover {
            text-decoration: underline;
        }
        .file-status {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }
        .format-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .format-buttons button {
            padding: 10px 15px;
            border: 1px solid #333;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        .format-buttons button.active {
            background: #333;
            color: white;
        }
        .hidden {
            display: none;
        }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <div class="import-container">
        <a href="index.html" class="back-btn">‚Üê Back to Home</a>
        <h2>Import CSV Files</h2>
        <p>Select your building simulation result format:</p>

        <!--  Format selection buttons -->
        <div class="format-buttons">
            <button id="iesveBtn" class="active">IESVE</button>
            <button id="openStudioBtn">OpenStudio</button>
            <button id="equestBtn">eQuest</button>
        </div>

        <form class="import-form" id="csvForm">
            <div class="upload-section iesve-section">
                <h3>Current Energy Data</h3>
                <p>Upload your current energy consumption data in CSV format.</p>
                <div class="file-input" id="currentDropZone">
                    <input type="file" id="currentCsvFile" accept=".csv" style="display: none;">
                    <p>Click to select or drag and drop your current data CSV file here</p>
                </div>
                <div class="file-status" id="currentFileStatus"></div>
            </div>

            <div class="upload-section iesve-section">
                <h3>Future Energy Data</h3>
                <p>Upload your predicted or target future energy consumption data in CSV format.</p>
                <div class="file-input" id="futureDropZone">
                    <input type="file" id="futureCsvFile" accept=".csv" style="display: none;">
                    <p>Click to select or drag and drop your future data CSV file here</p>
                </div>
                <div class="file-status" id="futureFileStatus"></div>
            </div>

            <button type="submit" class="submit-btn iesve-section">Upload and Analyze</button>
        </form>
    </div>

    <div id="chart" style="margin-top: 3rem;"></div>

    <script>
        const iesveBtn = document.getElementById('iesveBtn');
        const openStudioBtn = document.getElementById('openStudioBtn');
        const equestBtn = document.getElementById('equestBtn');

        const iesveSections = document.querySelectorAll('.iesve-section');

        function showIESVE() {
            iesveBtn.classList.add('active');
            openStudioBtn.classList.remove('active');
            equestBtn.classList.remove('active');
            iesveSections.forEach(el => el.classList.remove('hidden'));
        }

        function hideIESVE() {
            iesveSections.forEach(el => el.classList.add('hidden'));
        }

        iesveBtn.addEventListener('click', showIESVE);

        openStudioBtn.addEventListener('click', () => {
            alert('OpenStudio import not yet supported.');
            openStudioBtn.classList.add('active');
            iesveBtn.classList.remove('active');
            equestBtn.classList.remove('active');
            hideIESVE();
        });

        equestBtn.addEventListener('click', () => {
            alert('eQuest import not yet supported.');
            equestBtn.classList.add('active');
            iesveBtn.classList.remove('active');
            openStudioBtn.classList.remove('active');
            hideIESVE();
        });

        const form = document.getElementById('csvForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!iesveBtn.classList.contains('active')) {
                alert('Only IESVE format is currently supported.');
                return;
            }

            const currentFile = document.getElementById('currentCsvFile').files[0];
            if (!currentFile) {
                alert('Please upload the current CSV file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const text = e.target.result;
                const lines = text.split("\n").map(line => line.split(","));

                const headers = lines[4].map(h => h.trim());
                const totalRow = lines[19];

                const keys = [
                    "Interior Lighting (MBtu)",
                    "Receptacle Equipment (MBtu)",
                    "Space Heating (MBtu)",
                    "Service Water Heating (MBtu)",
                    "Space Cooling (MBtu)",
                    "Heat Rejection (MBtu)",
                    "Interior Central Fans (MBtu)",
                    "Interior Local Fans (MBtu)",
                    "Exhaust Fans (MBtu)",
                    "Pumps (MBtu)"
                ];

                const totals = {};
                headers.forEach((header, i) => {
                    if (keys.includes(header)) {
                        totals[header] = parseFloat(totalRow[i]) || 0;
                    }
                });

                drawD3AnnualStackedBar(totals, keys);
            };
            reader.readAsText(currentFile);
        });

        function drawD3AnnualStackedBar(totals, keys) {
            const stackedData = [totals];
            const stack = d3.stack().keys(keys);
            const series = stack(stackedData);

            const container = d3.select("#chart");
            container.html("");

            const margin = { top: 30, right: 120, bottom: 60, left: 80 },
                width = 600 - margin.left - margin.right,
                height = 400 - margin.top - margin.bottom;

            const svg = container.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const y = d3.scaleLinear()
                .domain([0, d3.sum(Object.values(totals))])
                .nice()
                .range([height, 0]);

            const color = d3.scaleOrdinal()
                .domain(keys)
                .range(d3.schemeCategory10);

            svg.selectAll("rect")
                .data(series)
                .join("rect")
                .attr("x", width / 2 - 40)
                .attr("y", d => y(d[0][1]))
                .attr("height", d => y(d[0][0]) - y(d[0][1]))
                .attr("width", 80)
                .attr("fill", d => color(d.key));

            svg.append("g").call(d3.axisLeft(y));

            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height + 35)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .text("Total Annual Energy Consumption");

            const legend = svg.append("g")
                .attr("transform", `translate(${width + 10}, 0)`);

            keys.forEach((key, i) => {
                legend.append("rect")
                    .attr("x", 0)
                    .attr("y", i * 20)
                    .attr("width", 12)
                    .attr("height", 12)
                    .attr("fill", color(key));

                legend.append("text")
                    .attr("x", 18)
                    .attr("y", i * 20 + 10)
                    .attr("font-size", "12px")
                    .text(key);
            });
        }

        //  Initialize with IESVE visible only
        showIESVE();
    </script>
</body>
</html>
