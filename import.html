<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import CSV - SmartWatts</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .import-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .import-form {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    .upload-section {
      border: 1px solid #eee;
      padding: 1.5rem;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .upload-section h3 {
      margin-top: 0;
      color: #333;
    }
    .file-input {
      padding: 1rem;
      border: 2px dashed #ccc;
      border-radius: 4px;
      text-align: center;
      cursor: pointer;
      background: #fff;
      margin: 1rem 0;
    }
    .file-input:hover {
      border-color: #666;
    }
    .submit-btn {
      background: #333;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      width: 100%;
      margin-top: 1rem;
    }
    .submit-btn:hover {
      background: #444;
    }
    .back-btn {
      display: inline-block;
      margin-bottom: 1rem;
      color: #333;
      text-decoration: none;
    }
    .back-btn:hover {
      text-decoration: underline;
    }
    .file-status {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #666;
    }
    .csv-preview {
      margin-top: 1rem;
      max-height: 300px;
      overflow: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .csv-preview table {
      width: 100%;
      border-collapse: collapse;
    }
    .csv-preview th, .csv-preview td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      font-size: 0.9rem;
    }
    .csv-preview th {
      background-color: #f5f5f5;
      position: sticky;
      top: 0;
    }
    .csv-preview tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .format-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin: 1.5rem 0;
    }
    .format-buttons button {
      padding: 10px 15px;
      border: 1px solid #333;
      background: white;
      cursor: pointer;
      border-radius: 4px;
    }
    .format-buttons button.active {
      background: #333;
      color: white;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="import-container">
    <a href="index.html" class="back-btn">‚Üê Back to Home</a>
    <h2>Import Raw Data Files</h2>
    <p>Select your building simulation result format:</p>

    <div class="format-buttons">
      <button id="iesveBtn" class="active">IESVE</button>
      <button id="openStudioBtn">OpenStudio</button>
      <button id="equestBtn">eQuest</button>
    </div>

    <form class="import-form" id="csvForm">
      <div class="upload-section iesve-section">
        <h3>Current Energy Data</h3>
        <p>Upload your current energy consumption data in CSV format.</p>
        <div class="file-input" id="currentDropZone">
          <input type="file" id="currentCsvFile" accept=".csv" style="display: none;">
          <p>Click to select or drag and drop your current data CSV file here</p>
        </div>
        <div class="file-status" id="currentFileStatus"></div>
        <div class="csv-preview" id="currentCsvPreview"></div>
      </div>

      <div class="upload-section iesve-section">
        <h3>Future Energy Data</h3>
        <p>Upload your predicted or target future energy consumption data in CSV format.</p>
        <div class="file-input" id="futureDropZone">
          <input type="file" id="futureCsvFile" accept=".csv" style="display: none;">
          <p>Click to select or drag and drop your future data CSV file here</p>
        </div>
        <div class="file-status" id="futureFileStatus"></div>
        <div class="csv-preview" id="futureCsvPreview"></div>
      </div>

      <button type="submit" class="submit-btn iesve-section">Upload and Analyze</button>
    </form>
  </div>

  <script>
    const iesveBtn = document.getElementById('iesveBtn');
    const openStudioBtn = document.getElementById('openStudioBtn');
    const equestBtn = document.getElementById('equestBtn');
    const iesveSections = document.querySelectorAll('.iesve-section');

    function showIESVE() {
      iesveBtn.classList.add('active');
      openStudioBtn.classList.remove('active');
      equestBtn.classList.remove('active');
      iesveSections.forEach(el => el.classList.remove('hidden'));
    }

    function hideIESVE() {
      iesveSections.forEach(el => el.classList.add('hidden'));
    }

    iesveBtn.addEventListener('click', showIESVE);

    openStudioBtn.addEventListener('click', () => {
      alert('OpenStudio import not yet supported.');
      openStudioBtn.classList.add('active');
      iesveBtn.classList.remove('active');
      equestBtn.classList.remove('active');
      hideIESVE();
    });

    equestBtn.addEventListener('click', () => {
      alert('eQuest import not yet supported.');
      equestBtn.classList.add('active');
      iesveBtn.classList.remove('active');
      openStudioBtn.classList.remove('active');
      hideIESVE();
    });

    document.getElementById('currentDropZone').addEventListener('click', () => {
      document.getElementById('currentCsvFile').click();
    });
    document.getElementById('futureDropZone').addEventListener('click', () => {
      document.getElementById('futureCsvFile').click();
    });

    document.getElementById('currentCsvFile').addEventListener('change', (e) => {
        const file = e.target.files[0];
        const status = document.getElementById('currentFileStatus');
        const preview = document.getElementById('currentCsvPreview');
        if (file) {
            status.textContent = `${file.name} uploaded successfully.`;
            status.style.color = '#28a745'; // green
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split('\n')
                    .map(row => row.split(','))
                    .filter(row => row.some(cell => cell.trim() !== '')); // Remove rows where all cells are empty
                
                const table = document.createElement('table');
                
                // Create header
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                rows[0].forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // Create body
                const tbody = document.createElement('tbody');
                for (let i = 1; i < rows.length; i++) {
                    const tr = document.createElement('tr');
                    rows[i].forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                }
                table.appendChild(tbody);
                
                preview.innerHTML = '';
                preview.appendChild(table);
            };
            reader.readAsText(file);
        } else {
            status.textContent = '';
            status.style.color = '';
            preview.innerHTML = '';
        }
    });

    document.getElementById('futureCsvFile').addEventListener('change', (e) => {
        const file = e.target.files[0];
        const status = document.getElementById('futureFileStatus');
        const preview = document.getElementById('futureCsvPreview');
        if (file) {
            status.textContent = `${file.name} uploaded successfully.`;
            status.style.color = '#28a745'; // green
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split('\n')
                    .map(row => row.split(','))
                    .filter(row => row.some(cell => cell.trim() !== '')); // Remove rows where all cells are empty
                
                const table = document.createElement('table');
                
                // Create header
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                rows[0].forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // Create body
                const tbody = document.createElement('tbody');
                for (let i = 1; i < rows.length; i++) {
                    const tr = document.createElement('tr');
                    rows[i].forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                }
                table.appendChild(tbody);
                
                preview.innerHTML = '';
                preview.appendChild(table);
            };
            reader.readAsText(file);
        } else {
            status.textContent = '';
            status.style.color = '';
            preview.innerHTML = '';
        }
    });

    const form = document.getElementById('csvForm');
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!iesveBtn.classList.contains('active')) {
        alert('Only IESVE format is currently supported.');
        return;
      }

      const currentFile = document.getElementById('currentCsvFile').files[0];
      if (!currentFile) {
        alert('Please upload the current CSV file');
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        const encoded = encodeURIComponent(text);
        const tempLink = document.createElement('a');
        tempLink.href = `data:text/csv;charset=utf-8,${encoded}`;
        tempLink.download = "processed_iesve.csv";

        // Pass data via localStorage to new page
        localStorage.setItem("iesveCsvData", text);
        const futureFile = document.getElementById("futureCsvFile").files[0];
        const reader2 = new FileReader();
        reader2.onload = function(e2) {
            localStorage.setItem("iesveFutureCsvData", e2.target.result);
            window.location.href = "chart.html";
        };
        reader2.readAsText(futureFile);

      };
      reader.readAsText(currentFile);
    });

    showIESVE();
  </script>
</body>
</html>
